###############################################################################
# Humidity Intelligence — UI Gallery Submission
# Card ID: house-average-humidity-badge-mobile
#
# What this is:
# - Mobile-friendly "House Average Humidity" badge.
# - Colours + glow match Humidity Intelligence comfort band sensors:
#     sensor.house_humidity_target_low
#     sensor.house_humidity_target_high
#
# Requirements (custom cards):
# - custom:button-card
# - card-mod (optional, for pulse keyframes)
#
# CANONICAL BACKEND ENTITIES (expected):
# - sensor.house_average_humidity
# - sensor.house_humidity_target_low
# - sensor.house_humidity_target_high
# - binary_sensor.humidity_danger
# - binary_sensor.condensation_danger
# - binary_sensor.mould_danger
#
# EDIT ME (only if your entity IDs differ):
# - entity: sensor.house_average_humidity
# - target sensors: sensor.house_humidity_target_low / sensor.house_humidity_target_high
#
# Logic (comfort-band):
# - Within band (low..high): GREEN
# - Below low: COOL/BLUE (too dry vs target)
# - Above high: AMBER, then RED if high+7% or any Danger binary is ON
#
# Usage:
# - Paste this vertical-stack into any view, OR lift the single card.
###############################################################################

type: vertical-stack
cards:
  - type: custom:button-card
    entity: sensor.house_average_humidity
    icon: mdi:water-percent
    show_name: false
    show_state: true
    show_icon: true
    state_display: |
      [[[
        const h = Number(entity.state);
        if (isNaN(h)) return '—%';
        return `${h.toFixed(1)}%`;
      ]]]
    styles:
      grid:
        - grid-template-areas: ""i s""
        - grid-template-columns: 52px 1fr
        - align-items: center
        - column-gap: 12px
      card:
        - border-radius: 18px
        - padding: 14px 16px
        - background: rgba(10,12,16,0.62)
        - height: 88px
        - overflow: hidden

        # Border colour follows Humidity Intelligence comfort band
        - border: |
            [[[
              const h = Number(entity.state);

              const low  = Number(states['sensor.house_humidity_target_low']?.state);
              const high = Number(states['sensor.house_humidity_target_high']?.state);

              const humidDanger = states['binary_sensor.humidity_danger']?.state === 'on';
              const condDanger  = states['binary_sensor.condensation_danger']?.state === 'on';
              const mouldDanger = states['binary_sensor.mould_danger']?.state === 'on';
              const danger = humidDanger || condDanger || mouldDanger;

              if (danger) return '2px solid rgba(239,68,68,0.90)'; // RED (danger)

              if (isNaN(h) || isNaN(low) || isNaN(high))
                return '2px solid rgba(148,163,184,0.35)';         // neutral fallback

              if (h < low) return '2px solid rgba(56,189,248,0.90)';        // below band (blue)
              if (h <= high) return '2px solid rgba(74,222,128,0.90)';      // in band (green)
              if (h <= (high + 7)) return '2px solid rgba(250,204,21,0.90)';// above band (amber)
              return '2px solid rgba(239,68,68,0.90)';                       // far above band (red)
            ]]]

        # Glow follows same band logic
        - box-shadow: |
            [[[
              const h = Number(entity.state);

              const low  = Number(states['sensor.house_humidity_target_low']?.state);
              const high = Number(states['sensor.house_humidity_target_high']?.state);

              const humidDanger = states['binary_sensor.humidity_danger']?.state === 'on';
              const condDanger  = states['binary_sensor.condensation_danger']?.state === 'on';
              const mouldDanger = states['binary_sensor.mould_danger']?.state === 'on';
              const danger = humidDanger || condDanger || mouldDanger;

              if (danger) return '0 0 26px rgba(239,68,68,0.55)';

              if (isNaN(h) || isNaN(low) || isNaN(high))
                return '0 0 20px rgba(148,163,184,0.25)';

              if (h < low) return '0 0 26px rgba(56,189,248,0.55)';
              if (h <= high) return '0 0 26px rgba(74,222,128,0.55)';
              if (h <= (high + 7)) return '0 0 26px rgba(250,204,21,0.55)';
              return '0 0 26px rgba(239,68,68,0.55)';
            ]]]

        # Pulse when danger binaries are ON, or when far outside band
        - animation: |
            [[[
              const h = Number(entity.state);

              const low  = Number(states['sensor.house_humidity_target_low']?.state);
              const high = Number(states['sensor.house_humidity_target_high']?.state);

              const humidDanger = states['binary_sensor.humidity_danger']?.state === 'on';
              const condDanger  = states['binary_sensor.condensation_danger']?.state === 'on';
              const mouldDanger = states['binary_sensor.mould_danger']?.state === 'on';

              const farHigh = (!isNaN(high) && !isNaN(h)) ? (h > (high + 7)) : false;
              const farLow  = (!isNaN(low)  && !isNaN(h)) ? (h < (low - 7))  : false;

              const danger = humidDanger || condDanger || mouldDanger || farHigh || farLow;
              return danger ? 'cv_pulse 1.8s ease-in-out infinite' : 'none';
            ]]]
      icon:
        - width: 34px

        # Icon colour matches comfort band too
        - color: |
            [[[
              const h = Number(entity.state);
              const low  = Number(states['sensor.house_humidity_target_low']?.state);
              const high = Number(states['sensor.house_humidity_target_high']?.state);

              const humidDanger = states['binary_sensor.humidity_danger']?.state === 'on';
              const condDanger  = states['binary_sensor.condensation_danger']?.state === 'on';
              const mouldDanger = states['binary_sensor.mould_danger']?.state === 'on';
              const danger = humidDanger || condDanger || mouldDanger;

              if (danger) return '#ef4444';

              if (isNaN(h) || isNaN(low) || isNaN(high)) return '#94a3b8';

              if (h < low) return '#38bdf8';
              if (h <= high) return '#4ade80';
              if (h <= (high + 7)) return '#facc15';
              return '#ef4444';
            ]]]
      state:
        - font-size: 34px
        - font-weight: 800
        - letter-spacing: 0.3px
        - justify-self: start
    card_mod:
      style: |
        @keyframes cv_pulse {
          0%   { transform: scale(1); }
          50%  { transform: scale(1.02); }
          100% { transform: scale(1); }
        }
